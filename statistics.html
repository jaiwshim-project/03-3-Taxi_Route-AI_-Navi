<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>수익 통계 — 택시내비AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.min.css">
  <link rel="stylesheet" href="css/custom.css">
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

<!-- 헤더 -->
<div id="app-header"></div>

<!-- 메인 콘텐츠 -->
<main class="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 py-8">

  <!-- 페이지 타이틀 -->
  <div class="mb-8 animate-fade-in-up">
    <h1 class="text-3xl font-bold text-gray-900">수익 통계</h1>
    <p class="text-gray-500 mt-1">AI 기반 운행 데이터 분석 및 수익 현황</p>
  </div>

  <!-- 요약 카드 4개 -->
  <div id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-10"></div>

  <!-- 일별 수익 차트 (최근 7일) -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8 animate-fade-in-up">
    <h2 class="text-lg font-bold text-gray-900 mb-1">일별 수익 추이</h2>
    <p class="text-sm text-gray-500 mb-6">최근 7일간 일일 수익 현황</p>
    <div id="daily-chart" class="space-y-3"></div>
  </div>

  <!-- 2열 레이아웃: 시간대별 수익 + 탑승률 추이 -->
  <div class="grid lg:grid-cols-2 gap-8 mb-8">

    <!-- 시간대별 수익 패턴 -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 animate-fade-in-up">
      <h2 class="text-lg font-bold text-gray-900 mb-1">시간대별 수익 패턴</h2>
      <p class="text-sm text-gray-500 mb-6">24시간 평균 수익 분포</p>
      <div id="hourly-chart" class="flex items-end gap-[3px] h-48"></div>
      <div class="flex justify-between text-xs text-gray-400 mt-2">
        <span>00시</span><span>06시</span><span>12시</span><span>18시</span><span>23시</span>
      </div>
    </div>

    <!-- 탑승률 추이 -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 animate-fade-in-up">
      <h2 class="text-lg font-bold text-gray-900 mb-1">탑승률 추이</h2>
      <p class="text-sm text-gray-500 mb-6">최근 7일간 실차율 변화</p>
      <div id="occupancy-chart" class="space-y-3"></div>
      <div class="mt-4 flex items-center gap-4 text-sm">
        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-500"></div><span class="text-gray-600">AI 최적화 적용</span></div>
        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-gray-300"></div><span class="text-gray-600">업계 평균 (45%)</span></div>
      </div>
    </div>
  </div>

  <!-- TOP 핫스팟 테이블 -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8 animate-fade-in-up">
    <h2 class="text-lg font-bold text-gray-900 mb-1">TOP 수익 핫스팟</h2>
    <p class="text-sm text-gray-500 mb-6">방문 횟수 대비 수익이 높은 핫스팟 순위</p>
    <div class="overflow-x-auto">
      <table class="data-table" id="hotspot-table">
        <thead>
          <tr>
            <th class="text-center w-12">순위</th>
            <th>핫스팟명</th>
            <th>구역</th>
            <th class="text-center">방문 횟수</th>
            <th class="text-right">총 수익</th>
            <th class="text-right">평균 요금</th>
            <th class="text-center">수요 점수</th>
          </tr>
        </thead>
        <tbody id="hotspot-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- 구역별 성과 랭킹 -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 animate-fade-in-up">
    <h2 class="text-lg font-bold text-gray-900 mb-1">구역별 성과 랭킹</h2>
    <p class="text-sm text-gray-500 mb-6">서울시 구별 평균 수요 점수 및 예상 수익</p>
    <div id="district-ranking" class="space-y-3"></div>
  </div>

</main>

<!-- 푸터 -->
<div id="app-footer"></div>

<!-- 스크립트 -->
<script src="js/mock-data.js"></script>
<script src="js/shared.js"></script>
<script src="js/demand-engine.js"></script>
<script>
(function() {
  initPage('statistics');

  var now = new Date();
  var hour = now.getHours();
  var dow = now.getDay();
  var weather = 'clear';

  /* ── 요약 카드 데이터 ── */
  var dailySim = simulateRevenue('ai', 10, HOTSPOTS, weather);
  var monthly = estimateMonthlyIncome('ai');

  var weeklyNet = dailySim.netIncome * 6;

  var summaryData = [
    { label: '오늘 수익', value: fmtWon(dailySim.netIncome), sub: '연료비 제외 순수익', icon: '&#x1F4B0;', color: 'amber' },
    { label: '이번주 수익', value: fmtWon(weeklyNet), sub: '6일 기준 누적', icon: '&#x1F4C8;', color: 'orange' },
    { label: '이번달 수익', value: fmtWon(monthly.monthlyNet), sub: '25일 근무 기준', icon: '&#x1F4B5;', color: 'yellow' },
    { label: '운행 거리', value: fmt(Math.round((dailySim.totalOccupiedKm + dailySim.totalEmptyKm) * 25)) + 'km', sub: '이번달 총 운행거리', icon: '&#x1F697;', color: 'emerald' }
  ];

  var colorMap = {
    amber: { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-700', iconBg: 'bg-amber-100' },
    orange: { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700', iconBg: 'bg-orange-100' },
    yellow: { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-700', iconBg: 'bg-yellow-100' },
    emerald: { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-700', iconBg: 'bg-emerald-100' }
  };

  var cardsHTML = summaryData.map(function(s) {
    var c = colorMap[s.color];
    return '<div class="card-hover ' + c.bg + ' border ' + c.border + ' rounded-2xl p-5">' +
      '<div class="flex items-start justify-between mb-3">' +
        '<span class="text-sm font-medium text-gray-600">' + s.label + '</span>' +
        '<div class="w-10 h-10 ' + c.iconBg + ' rounded-xl flex items-center justify-center text-xl">' + s.icon + '</div>' +
      '</div>' +
      '<div class="text-2xl font-bold ' + c.text + '">' + s.value + '</div>' +
      '<p class="text-xs text-gray-500 mt-1">' + s.sub + '</p>' +
    '</div>';
  }).join('');
  document.getElementById('summary-cards').innerHTML = cardsHTML;

  /* ── 일별 수익 차트 (최근 7일) ── */
  var dayNames = ['일', '월', '화', '수', '목', '금', '토'];
  var dailyData = [];
  var maxDailyRev = 0;
  for (var d = 6; d >= 0; d--) {
    var pastDate = new Date(now);
    pastDate.setDate(pastDate.getDate() - d);
    var pastDow = pastDate.getDay();
    var pastWeather = d === 3 ? 'rain' : d === 5 ? 'cloudy' : 'clear';
    var sim = simulateRevenue('ai', 10, HOTSPOTS, pastWeather);
    // 일간 변동 시뮬레이션
    var variance = 0.9 + Math.random() * 0.2;
    var dayRev = Math.round(sim.netIncome * DAY_WEIGHTS[pastDow] * variance);
    if (dayRev > maxDailyRev) maxDailyRev = dayRev;
    dailyData.push({
      label: (pastDate.getMonth() + 1) + '/' + pastDate.getDate() + ' (' + dayNames[pastDow] + ')',
      revenue: dayRev,
      weather: pastWeather
    });
  }

  var dailyHTML = dailyData.map(function(dd) {
    var pct = Math.round((dd.revenue / maxDailyRev) * 100);
    var weatherIcon = dd.weather === 'rain' ? '&#x1F327;' : dd.weather === 'cloudy' ? '&#x26C5;' : '&#x2600;';
    return '<div class="flex items-center gap-3">' +
      '<span class="text-sm text-gray-600 w-32 shrink-0">' + dd.label + ' ' + weatherIcon + '</span>' +
      '<div class="flex-1 bg-gray-100 rounded-full h-8 overflow-hidden relative">' +
        '<div class="h-full rounded-full bg-gradient-to-r from-amber-400 to-orange-500 transition-all duration-700 flex items-center justify-end pr-3" style="width:' + pct + '%">' +
          '<span class="text-xs font-bold text-white drop-shadow">' + fmtWon(dd.revenue) + '</span>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');
  document.getElementById('daily-chart').innerHTML = dailyHTML;

  /* ── 시간대별 수익 패턴 (24시간) ── */
  var hourlyRevenues = [];
  var maxHourRev = 0;
  for (var h = 0; h < 24; h++) {
    var hDemand = HOURLY_DEMAND[h] || 0.5;
    var hRev = Math.round(hDemand * 45000 * (0.85 + Math.random() * 0.3));
    hourlyRevenues.push(hRev);
    if (hRev > maxHourRev) maxHourRev = hRev;
  }

  var hourlyHTML = hourlyRevenues.map(function(rev, i) {
    var pct = Math.max(5, Math.round((rev / maxHourRev) * 100));
    var isNow = (i === hour);
    var barColor = rev / maxHourRev > 0.75 ? 'bg-orange-500' : rev / maxHourRev > 0.5 ? 'bg-amber-400' : rev / maxHourRev > 0.25 ? 'bg-yellow-400' : 'bg-gray-300';
    if (isNow) barColor = 'bg-red-500 animate-glow';
    return '<div class="flex-1 flex flex-col items-center justify-end h-full group relative">' +
      '<div class="absolute -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-10">' +
        formatHour(i) + ' : ' + fmtWon(rev) +
      '</div>' +
      '<div class="w-full rounded-t ' + barColor + ' transition-all duration-300" style="height:' + pct + '%;min-height:4px"></div>' +
    '</div>';
  }).join('');
  document.getElementById('hourly-chart').innerHTML = hourlyHTML;

  /* ── 탑승률 추이 ── */
  var occData = [];
  var baseOcc = dailySim.occupancyRate;
  for (var o = 6; o >= 0; o--) {
    var pDate = new Date(now);
    pDate.setDate(pDate.getDate() - o);
    var oDow = pDate.getDay();
    var occVariance = -5 + Math.round(Math.random() * 10);
    var occRate = Math.min(95, Math.max(35, baseOcc + occVariance + (DAY_WEIGHTS[oDow] - 1) * 20));
    occData.push({
      label: (pDate.getMonth() + 1) + '/' + pDate.getDate() + ' (' + dayNames[oDow] + ')',
      rate: occRate
    });
  }

  var occHTML = occData.map(function(od) {
    var color = od.rate >= 65 ? 'from-amber-400 to-amber-500' : od.rate >= 50 ? 'from-yellow-400 to-yellow-500' : 'from-gray-300 to-gray-400';
    return '<div class="flex items-center gap-3">' +
      '<span class="text-sm text-gray-600 w-28 shrink-0">' + od.label + '</span>' +
      '<div class="flex-1 bg-gray-100 rounded-full h-6 overflow-hidden relative">' +
        '<div class="h-full rounded-full bg-gradient-to-r ' + color + ' transition-all duration-700" style="width:' + od.rate + '%"></div>' +
        '<div class="absolute top-0 left-[45%] h-full border-l-2 border-dashed border-gray-400 opacity-50"></div>' +
      '</div>' +
      '<span class="text-sm font-bold w-12 text-right ' + (od.rate >= 60 ? 'text-amber-600' : 'text-gray-500') + '">' + od.rate + '%</span>' +
    '</div>';
  }).join('');
  document.getElementById('occupancy-chart').innerHTML = occHTML;

  /* ── TOP 핫스팟 테이블 ── */
  var hotspotScored = HOTSPOTS.map(function(hs) {
    var score = calculateDemandScore(hs, hour, dow, weather);
    var visits = Math.round(hs.dailyPassengers / 100 * (0.8 + Math.random() * 0.4));
    var totalRev = visits * hs.avgFare;
    return { name: hs.name, district: hs.district, visits: visits, totalRev: totalRev, avgFare: hs.avgFare, score: score };
  });
  hotspotScored.sort(function(a, b) { return b.totalRev - a.totalRev; });

  var tbodyHTML = hotspotScored.slice(0, 15).map(function(hs, idx) {
    var grade = getDemandGrade(hs.score);
    var rankBadge = idx < 3
      ? '<span class="w-7 h-7 rounded-full bg-amber-500 text-white text-xs font-bold flex items-center justify-center">' + (idx + 1) + '</span>'
      : '<span class="text-sm text-gray-500 font-medium">' + (idx + 1) + '</span>';
    return '<tr class="hover:bg-amber-50/30 transition">' +
      '<td class="text-center">' + rankBadge + '</td>' +
      '<td class="font-semibold text-gray-900">' + hs.name + '</td>' +
      '<td class="text-gray-600">' + hs.district + '</td>' +
      '<td class="text-center">' + fmt(hs.visits) + '회</td>' +
      '<td class="text-right font-semibold text-amber-700">' + fmtWon(hs.totalRev) + '</td>' +
      '<td class="text-right text-gray-700">' + fmt(hs.avgFare) + '원</td>' +
      '<td class="text-center"><span class="px-2 py-1 rounded-full text-xs font-bold ' + grade.color + '">' + grade.grade + ' (' + hs.score + ')</span></td>' +
    '</tr>';
  }).join('');
  document.getElementById('hotspot-tbody').innerHTML = tbodyHTML;

  /* ── 구역별 성과 랭킹 ── */
  var districtData = aggregateDistrictDemand(hour, dow, weather);
  var maxDistScore = districtData.length > 0 ? districtData[0].avgScore : 100;

  var districtHTML = districtData.map(function(dist, idx) {
    var pct = Math.round((dist.avgScore / maxDistScore) * 100);
    var barColor = dist.avgScore >= 75 ? 'from-orange-500 to-red-500' : dist.avgScore >= 55 ? 'from-amber-400 to-orange-500' : 'from-yellow-300 to-amber-400';
    var medal = idx === 0 ? '&#x1F947;' : idx === 1 ? '&#x1F948;' : idx === 2 ? '&#x1F949;' : '<span class="text-sm text-gray-400 font-medium w-6 inline-block text-center">' + (idx + 1) + '</span>';
    // 구역의 핫스팟 데이터로 일간 예상 수익 추정
    var districtHotspots = getHotspotsByDistrict(dist.name);
    var estRev = 0;
    districtHotspots.forEach(function(hs) { estRev += hs.avgFare * Math.round(hs.dailyPassengers / 120); });
    return '<div class="flex items-center gap-4 p-3 rounded-xl hover:bg-amber-50/50 transition">' +
      '<div class="w-8 text-center text-lg">' + medal + '</div>' +
      '<div class="w-20 shrink-0"><span class="font-semibold text-gray-900 text-sm">' + dist.name + '</span></div>' +
      '<div class="flex-1">' +
        '<div class="bg-gray-100 rounded-full h-5 overflow-hidden">' +
          '<div class="h-full rounded-full bg-gradient-to-r ' + barColor + ' transition-all duration-700" style="width:' + pct + '%"></div>' +
        '</div>' +
      '</div>' +
      '<div class="w-16 text-right"><span class="text-sm font-bold ' + getScoreColor(dist.avgScore) + '">' + dist.avgScore + '점</span></div>' +
      '<div class="w-24 text-right"><span class="text-xs text-gray-500">예상 ' + fmtWon(estRev) + '</span></div>' +
      '<div class="w-28 text-right hidden sm:block"><span class="text-xs text-gray-400">TOP: ' + (dist.topSpot || '-') + '</span></div>' +
    '</div>';
  }).join('');
  document.getElementById('district-ranking').innerHTML = districtHTML;

})();
</script>
</body>
</html>
